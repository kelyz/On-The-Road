<!DOCTYPE HTML>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<title> Search </title>
		<style>
			#map {
				height: 100%;
			}
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body onload="initMap()">
		<div id="floating-panel">
			<b>Start: </b><input type="text" id="start" value="{{ start }}">
			<b>End: </b><input type="text" id="end" value="{{ end }}">
		</div>
			<div id="map"></div>
		<script type="text/javascript">
			function initMap() {
				var venuelat = 0;
				var venuelng = 0;
				var venueName = "";
				var markerArray = [];
	        	var directionsService = new google.maps.DirectionsService;
	        	var map = new google.maps.Map(document.getElementById('map'), {
	          		zoom: 15,
	        	});
	        	var directionsDisplay = new google.maps.DirectionsRenderer({map: map});
	        	var stepDisplay = new google.maps.InfoWindow;

	        	var onChangeHandler = function() {
	        		calculateAndDisplayRoute(
	        			venuelat, venuelng, venueName, directionsDisplay, directionsService, markerArray, stepDisplay, map);
	        		};
	        	document.getElementById('start').addEventListener('change', onChangeHandler);
	        	document.getElementById('end').addEventListener('change', onChangeHandler);

	        	var originlat = {{ originlat }}
	        	var originlng = {{ originlng }}
	        	var endlat = {{ endlat }}
	        	var endlng = {{ endlng }}

	        	var request = {
	        		origin: new google.maps.LatLng(originlat, originlng),
	        		destination: new google.maps.LatLng(endlat, endlng),
	        		travelMode: google.maps.TravelMode.DRIVING,
	       			avoidHighways: false,
	       			avoidTolls: false
	        	};

	        	directionsService.route(request, function(response, status) {
	        		if (status == google.maps.DirectionsStatus.OK) {
	        			directionsDisplay.setDirections(response);
	        			var path = response.routes[0].overview_path;
	        			var pathArray = [];
	 
	        			var i = 0;
	        			var j = 0;

	        			for (j = 0; j < path.length; j++) {
	        				pathArray[i] = path[j].lat();
	        				i++;
	        				pathArray[i] = path[j].lng();
	        				i++;
	        			}

	        			$.ajax({
	        				type: 'POST',
	        				url: window.location.href,
	        				data: JSON.stringify(pathArray),
	        				contentType: "application/json; charset=utf-8",
	        				success: function(data) {
	        					console.log(data)

        						for (var i = 0; i < data.length; i++) {
	        						venueName = data[i][0];
	        						venuelat = data[i][1];
	        						venuelng = data[i][2];

	        						calculateAndDisplayRoute(venuelat, venuelng, venueName, directionsDisplay, directionsService, markerArray, stepDisplay, map
	            					);
	        				 	}
	        				},
	        				error: function(error) {
	        					console.log(error)
	        				}
	        			});
	        		}
	        	});
	        }

	      	function calculateAndDisplayRoute(venuelat, venuelng, venueName, directionsDisplay, directionsService,
	      		markerArray, stepDisplay, map) {

	        	for (var i = 0; i < markerArray.length; i++) {
	        		markerArray[i].setMap(null);
	        	}

	        	directionsService.route({
	        		origin: document.getElementById('start').value,
	        		destination: document.getElementById('end').value,
	        		travelMode: 'DRIVING'
	        	}, function(response, status) {
	          // Route the directions and pass the response to a function to create
	          // markers for each step.
	          if (status === 'OK') {
	                directionsDisplay.setDirections(response);
	                showVenues(venuelat, venuelng, venueName, response, markerArray, stepDisplay, map);
	            } else {
	            	setTimeout(function(){
	                	directionsDisplay.setDirections(response);
	                	showVenues(venuelat, venuelng, venueName, response, markerArray, stepDisplay, map);
	                }, 1000);
	            }
	        });
	    }

	    function showVenues(venuelat, venuelng, venueName, directionResult, markerArray, stepDisplay, map) {
	    	var marker = new google.maps.Marker;
	    	var latlnglocator = new google.maps.LatLng(venuelat, venuelng);
	    	marker.setMap(map);
	    	marker.setPosition(latlnglocator)
	    	attachInstructionText(stepDisplay, marker, venueName, map);
	    }

	    // function showSteps(directionResult, markerArray, stepDisplay, map) {
	    //     // For each step, place a marker, and add the text to the marker's infowindow.
	    //     // Also attach the marker to an array so we can keep track of it and remove it
	    //     // when calculating new routes.
	    //     var myRoute = directionResult.routes[0].legs[0];
	    //     for (var i = 0; i < myRoute.steps.length; i++) {
	    //     	var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
	    //     	marker.setMap(map);
	    //     	marker.setPosition(myRoute.steps[i].start_location);
	    //     	attachInstructionText(
	    //     		stepDisplay, marker, myRoute.steps[i].instructions, map);
	    //     }
	    // }

	    function attachInstructionText(stepDisplay, marker, text, map) {
	    	google.maps.event.addListener(marker, 'click', function() {
	          stepDisplay.setContent(text);
	          stepDisplay.open(map, marker);
	      });
	    }
		</script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
    	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGacJJrvstnrNLVlRLpK28gt4V1OgKU8o&libraries=places&callback=initMap" async defer></script>
	</body>
</html>